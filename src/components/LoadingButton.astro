---
// Loading button component
// Shows spinner and disables button during form submission
interface Props {
  class?: string;
  style?: string;
  type?: "submit" | "button";
  disabled?: boolean;
  variant?: "primary" | "outline" | "danger";
}

const {
  class: className = "",
  style = "",
  type = "submit",
  disabled = false,
  variant = "primary"
} = Astro.props;

const variantClass = variant === "outline" ? "btn-outline" : variant === "danger" ? "btn-danger" : "btn-primary";
---
<button
  class:list={["btn", "loading-btn", variantClass, className]}
  style={style}
  type={type}
  disabled={disabled}
  data-loading-btn
>
  <span class="btn-text"><slot /></span>
  <span class="btn-spinner" aria-hidden="true">
    <svg class="spinner-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" stroke-linecap="round" opacity="0.25"/>
      <path d="M12 2C6.48 2 2 6.48 2 12" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
    </svg>
  </span>
</button>

<style>
  .loading-btn {
    position: relative;
  }

  .btn-text {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    transition: opacity 0.2s;
  }

  .btn-spinner {
    position: absolute;
    inset: 0;
    display: none;
    align-items: center;
    justify-content: center;
  }

  .spinner-icon {
    width: 20px;
    height: 20px;
    animation: spin 0.8s linear infinite;
  }

  .loading-btn[data-loading="true"] .btn-text {
    opacity: 0;
  }

  .loading-btn[data-loading="true"] .btn-spinner {
    display: flex;
  }

  .loading-btn[data-loading="true"] {
    pointer-events: none;
    opacity: 0.8;
  }

  .btn-danger {
    background: transparent;
    border: 1px solid color-mix(in oklab, #ef4444 30%, transparent);
    color: #ef4444;
  }

  .btn-danger:hover {
    background: color-mix(in oklab, #ef4444 10%, transparent);
    border-color: #ef4444;
  }

  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }
</style>

<script>
  // Handle form submission loading state
  function initLoadingButtons() {
    document.querySelectorAll("form").forEach((form) => {
      form.addEventListener("submit", () => {
        const btn = form.querySelector("[data-loading-btn]") as HTMLButtonElement | null;
        if (btn && !btn.disabled) {
          btn.setAttribute("data-loading", "true");
          btn.setAttribute("aria-busy", "true");
        }
      });
    });
  }

  // Initialize on DOM ready
  document.addEventListener("DOMContentLoaded", initLoadingButtons);

  // Re-initialize on Astro page transitions
  document.addEventListener("astro:page-load", initLoadingButtons);
</script>
