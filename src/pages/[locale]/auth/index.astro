---
export const prerender = false;

import Layout from "../../../shared/Layout.astro";
import { getSupabaseServerClient } from "../../../lib/supabase";
import { getLocaleFromUrl, useTranslations } from "../../../i18n";

const locale = getLocaleFromUrl(Astro.url);
const t = useTranslations(locale);
const localePath = (path: string) => `/${locale}${path}`;

const qs = new URL(Astro.request.url).searchParams;
const error = qs.get("error");
const message = qs.get("message");
const mode = qs.get("mode") === "signup" ? "signup" : "signin";
const isSignup = mode === "signup";
const supabase = getSupabaseServerClient(Astro);
const { data } = await supabase.auth.getUser();
if (data.user) {
  return Astro.redirect(localePath("/dashboard"));
}
---
<Layout title={t.auth.signIn} locale={locale}>
  <section class="grid fade-in" style="max-width:720px; margin:0 auto">
    <h2 style="text-align:center">{t.auth.welcome}</h2>
    { error ? (
      <div class="card" style="border-color:#ef4444;background: color-mix(in oklab, #ef4444 12%, transparent)">
        <strong style="color:#ef4444">{t.common.error}</strong>
        <p class="lead" style="margin-top:6px">{error}</p>
      </div>
    ) : null }
    {
      message ? (
      <div class="card" style="border-color:#22c55e;background: color-mix(in oklab, #22c55e 12%, transparent)">
        <strong style="color:#22c55e">{t.common.notice}</strong>
        <p class="lead" style="margin-top:6px">{message}</p>
      </div>
      ) : null
    }

    <div class="card" style="max-width:480px; margin:0 auto">
      <h3 style="margin-top:0">{isSignup ? t.auth.createAccount : t.auth.signInLink}</h3>
      <form action={isSignup ? "/auth/email-signup" : "/auth/email-signin"} method="POST" style="display:grid; gap:12px">
        <label>
          <div class="muted" style="margin-bottom:4px">{t.auth.email}</div>
          <input
            name="email"
            type="email"
            required
            style="width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--color-border); background: #F1F5F9"
          />
        </label>
        <label>
          <div class="muted" style="margin-bottom:4px">{t.auth.password}</div>
          <input
            name="password"
            type="password"
            minlength="6"
            required
            style="width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--color-border); background: #F1F5F9"
          />
        </label>
        <input type="hidden" name="locale" value={locale} />
        <button class="btn btn-primary" type="submit">{isSignup ? t.auth.createAccount : t.auth.signInLink}</button>
      </form>
      <div class="hero-actions" style="margin-top:12px">
        <a href="/auth/oauth/github" class="btn btn-outline">{t.auth.continueWith} {t.auth.github}</a>
        <a href="/auth/oauth/google" class="btn btn-outline">{t.auth.continueWith} {t.auth.google}</a>
      </div>
      <p class="muted" style="margin-top:16px; font-size:14px">
        {
          isSignup ? (
            <>
              {t.auth.hasAccount}
              {" "}
              <a href={localePath("/auth?mode=signin")}>{t.auth.signInLink}</a>
            </>
          ) : (
            <>
              {t.auth.noAccount}
              {" "}
              <a href={localePath("/auth?mode=signup")}>{t.auth.createAccount}</a>
            </>
          )
        }
      </p>
    </div>
  </section>
</Layout>
