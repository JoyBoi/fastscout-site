---
import Layout from "../shared/Layout.astro";
import RenewalCountdown from "../components/RenewalCountdown.astro";
import stripe, { findActiveSubscriptionByEmail, findActiveSubscriptionByCustomerId } from "../lib/stripe";
import { getSupabaseServerClient } from "../lib/supabase";

const supabase = getSupabaseServerClient(Astro);
const { data } = await supabase.auth.getUser();
if (!data.user) return Astro.redirect("/auth/signin");
const userEmail = data.user?.email as string | undefined;
const userId = data.user?.id as string | undefined;

let sub = { active: false, customerId: undefined, priceId: undefined, periodEnd: undefined } as { active: boolean; customerId?: string; priceId?: string; periodEnd?: string };
let invoices: Array<{ id: string; status: string | null; amount_due: number; currency: string; hosted_invoice_url: string | null; invoice_pdf: string | null; created: number }> = [];
let nextBilling: string | null = null;
let planLabel: string | null = null;
let renewalDays: number | null = null;
let lastInvoiceAmount: string | null = null;
let lastInvoiceDate: string | null = null;
const base = import.meta.env.STRIPE_WRAPPER_BASE_URL as string;
const displayName = (data.user?.user_metadata as any)?.name ?? userEmail ?? "";
const avatarInitial = (displayName || "U").slice(0, 1).toUpperCase();
let invoicesCount = 0;

// Cache billing_customers to avoid duplicate lookups
let cachedBillingMap: { stripe_customer_id?: string } | null = null;
let billingMapFetched = false;

// Fetch subscription_status, billing_customers, and session in parallel
const [statusResult, billingResult, sessionResult] = await Promise.all([
  userId
    ? supabase.from("subscription_status").select("active, price_id, current_period_end").eq("user_id", userId).maybeSingle()
    : Promise.resolve({ data: null }),
  userId
    ? supabase.from("billing_customers").select("stripe_customer_id").eq("user_id", userId).maybeSingle()
    : Promise.resolve({ data: null }),
  supabase.auth.getSession()
]);

const status = statusResult.data;
cachedBillingMap = billingResult.data;
billingMapFetched = true;
const accessToken = sessionResult.data.session?.access_token;

if (status) {
  sub = { active: !!status.active, priceId: status.price_id ?? undefined, periodEnd: status.current_period_end ?? undefined };
} else if (userId) {
  // Use cached billing_customers result
  if (cachedBillingMap?.stripe_customer_id) {
    sub = await findActiveSubscriptionByCustomerId(cachedBillingMap.stripe_customer_id);
  } else if (userEmail) {
    sub = await findActiveSubscriptionByEmail(userEmail);
  }
}

if (accessToken && base) {
  const res = await fetch(`${base}/invoices`, { headers: { Authorization: `Bearer ${accessToken}` } });
  if (res.ok) {
    const j = await res.json() as { invoices: typeof invoices };
    invoices = j.invoices ?? [];
  }
}
if (invoices.length === 0 && userEmail) {
  // Reuse cached billing_customers result
  let customerId = cachedBillingMap?.stripe_customer_id as string | undefined;
  if (!customerId) {
    const customers = await stripe.customers.list({ email: userEmail, limit: 1 });
    customerId = customers.data[0]?.id;
  }
  if (customerId) {
    const list = await stripe.invoices.list({ customer: customerId, limit: 20 });
    invoices = list.data.map((i) => ({
      id: i.id,
      status: (i.status ?? null) as unknown as string | null,
      amount_due: i.amount_due,
      currency: i.currency,
      hosted_invoice_url: i.hosted_invoice_url ?? null,
      invoice_pdf: i.invoice_pdf ?? null,
      created: i.created,
    }));
  }
}
invoicesCount = invoices.length;
if (invoices.length > 0) {
  const latest = invoices.reduce((a, b) => (a.created > b.created ? a : b));
  lastInvoiceAmount = `${(latest.amount_due / 100).toFixed(2)} ${latest.currency.toUpperCase()}`;
  lastInvoiceDate = new Date(latest.created * 1000).toLocaleDateString();
}
if (sub.periodEnd) {
  try {
    const dt = new Date(sub.periodEnd);
    nextBilling = dt.toLocaleDateString();
    const diffMs = dt.getTime() - Date.now();
    renewalDays = diffMs > 0 ? Math.ceil(diffMs / (1000 * 60 * 60 * 24)) : 0;
  } catch {}
}
const monthlyPrice = import.meta.env.STRIPE_PRICE_ID_MONTHLY as string | undefined;
const yearlyPrice = import.meta.env.STRIPE_PRICE_ID_YEARLY as string | undefined;
if (sub.priceId) {
  if (monthlyPrice && sub.priceId === monthlyPrice) planLabel = "Monthly";
  else if (yearlyPrice && sub.priceId === yearlyPrice) planLabel = "Annual";
}
const urlError = new URL(Astro.request.url).searchParams.get("error");
const urlSuccess = new URL(Astro.request.url).searchParams.get("success");
let errorBanner: string | null = null;
let successBanner: string | null = null;
let errorCtaHref: string | null = null;
let errorCtaLabel: string | null = null;
let successCtaHref: string | null = null;
let successCtaLabel: string | null = null;
if (urlError === "rate_limited") errorBanner = "Too many requests. Try again in a minute.";
else if (urlError === "rate_limit_error") errorBanner = "Rate limit service error. Please retry.";
else if (urlError === "misconfigured_edge_function") errorBanner = "Billing service is misconfigured.";
else if (urlError === "checkout_failed") errorBanner = "Checkout failed. Please try again.";
else if (urlError === "missing_price_id") errorBanner = "Price configuration missing.";
else if (urlError === "no_active_subscription") {
  errorBanner = "You do not have an active subscription to change.";
  errorCtaHref = "/pricing";
  errorCtaLabel = "View pricing";
}
if (urlSuccess === "plan_change_scheduled") {
  successBanner = "Plan change scheduled. It will apply next cycle.";
  successCtaHref = "/api/portal";
  successCtaLabel = "Manage billing";
} else if (urlSuccess === "plan_unchanged") {
  successBanner = "You are already on this plan.";
  successCtaHref = "/pricing";
  successCtaLabel = "View other plans";
}
---
<Layout title="Dashboard">
  <div class="glow-orb" style="top: -10%; right: -10%; width: 600px; height: 600px; background: radial-gradient(circle, rgba(59, 130, 246, 0.05) 0%, transparent 70%); filter: blur(60px); position: absolute; z-index: -1;"></div>

  <section class="container section" style="max-width: 1000px; padding-top: 30px;">
    
    <div style="margin-bottom: 40px; display: flex; justify-content: space-between; align-items: flex-end;">
      <div>
        <h1 style="font-size: 2.5rem; font-weight: 800; letter-spacing: -1px; margin-bottom: 8px;">Dashboard</h1>
        <p class="muted" style="font-size: 1.1rem;">Welcome back, {displayName.split(' ')[0]}</p>
      </div>
      <form action="/auth/signout" method="POST">
        <button class="btn btn-outline" style="font-size: 14px; padding: 8px 16px;">Sign out</button>
      </form>
    </div>

    {
      errorBanner ? (
        <div class="card" style="border-color:#ef4444;background: color-mix(in oklab, #ef4444 8%, transparent); margin-bottom: 32px;">
          <strong style="color:#ef4444; display:flex; align-items:center; gap:8px">
            <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
            Action Required
          </strong>
          <p class="muted" style="margin-top:4px">{errorBanner}</p>
          {
            errorCtaHref && errorCtaLabel ? (
              <div style="margin-top:12px">
                <a class="btn" href={errorCtaHref}>{errorCtaLabel}</a>
              </div>
            ) : null
          }
        </div>
      ) : null
    }

    {
      successBanner ? (
        <div class="card" style="border-color:#22c55e;background: color-mix(in oklab, #22c55e 8%, transparent); margin-bottom: 32px;">
           <strong style="color:#16a34a; display:flex; align-items:center; gap:8px">
            <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
            Success
          </strong>
          <p class="muted" style="margin-top:4px">{successBanner}</p>
          {
            successCtaHref && successCtaLabel ? (
              <div style="margin-top:12px">
                <a class="btn" href={successCtaHref}>{successCtaLabel}</a>
              </div>
            ) : null
          }
        </div>
      ) : null
    }

    <div class="dashboard-grid">
      <!-- Main Column -->
      <div style="display: flex; flex-direction: column; gap: 24px;">
        
        <!-- Subscription Status Card -->
        <div class="card sub-card">
          <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 24px;">
            <div>
              <p class="badge" style="margin-bottom: 12px; background: rgba(255,255,255,0.2); color: white;">Current Plan</p>
              <h2 style="color: white; font-size: 2rem; margin: 0;">{planLabel ?? (sub.active ? "Active Plan" : "Free Tier")}</h2>
            </div>
            { sub.active ? <div class="status-pill active">Active</div> : <div class="status-pill inactive">Inactive</div> }
          </div>

          <div style="margin-top: auto;">
             {
              sub.active ? (
                <div style="display:flex; justify-content: space-between; align-items: flex-end;">
                   <div>
                      <p style="color: rgba(255,255,255,0.7); font-size: 14px; margin-bottom: 4px;">Next billing</p>
                      <p style="color: white; font-weight: 600; font-size: 16px;">{nextBilling}</p>
                   </div>
                   <form action="/api/portal" method="POST">
                      <button class="btn" style="background: white; color: var(--color-primary); border: none;">Manage Billing</button>
                   </form>
                </div>
              ) : (
                <div style="display:flex; justify-content: space-between; align-items: center;">
                  <p style="color: rgba(255,255,255,0.8);">Unlock full access to FastScout.</p>
                  <a class="btn" href="/pricing" style="background: white; color: var(--color-primary); border: none;">Upgrade Plan</a>
                </div>
              )
            }
          </div>
        </div>

        <!-- Invoices -->
        <div class="card">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="font-size: 1.25rem; font-weight: 700;">Billing History</h3>
            <span class="muted" style="font-size: 14px;">Last 12 months</span>
          </div>
          
          {
            invoices.length > 0 ? (
              <ul class="invoice-list">
                {
                  invoices.map((i) => (
                    <li>
                      <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="width: 36px; height: 36px; background: var(--color-bg); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: var(--color-text-muted);">
                          <svg width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                        </div>
                        <div>
                          <div style="font-weight: 600; font-size: 15px;">Invoice #{i.id.slice(-6).toUpperCase()}</div>
                          <div class="muted" style="font-size: 13px;">{new Date(i.created * 1000).toLocaleDateString()}</div>
                        </div>
                      </div>
                      <div style="display: flex; align-items: center; gap: 16px;">
                        <span style="font-weight: 600; font-size: 15px;">{(i.amount_due / 100).toFixed(2)} {i.currency.toUpperCase()}</span>
                        {
                          i.invoice_pdf ? (
                            <a href={i.invoice_pdf} target="_blank" rel="noreferrer" class="btn-icon" title="Download PDF">
                              <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                            </a>
                          ) : null
                        }
                      </div>
                    </li>
                  ))
                }
              </ul>
            ) : (
              <div style="text-align: center; padding: 40px 0;">
                <p class="muted">No invoices found.</p>
              </div>
            )
          }
        </div>
      </div>

      <!-- Side Column -->
      <div style="display: flex; flex-direction: column; gap: 24px;">
        <!-- Profile Card -->
        <div class="card">
          <div style="display:flex; align-items:center; gap:16px; margin-bottom: 20px;">
            <div style="width:56px; height:56px; border-radius:50%; background: linear-gradient(135deg, #e0e7ff 0%, #fae8ff 100%); display:flex; align-items:center; justify-content:center; font-weight:700; font-size: 24px; color: var(--color-primary);">
              {avatarInitial}
            </div>
            <div>
              <div style="font-weight:700; font-size: 1.1rem; line-height: 1.2;">{displayName}</div>
              <div class="muted" style="font-size:14px">{userEmail}</div>
            </div>
          </div>
          
          <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 10px;">
            <div style="background: var(--color-bg); padding: 12px; border-radius: 12px; text-align: center;">
              <div class="muted" style="font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600;">Invoices</div>
              <div style="font-size: 24px; font-weight: 800; color: var(--color-text); margin-top: 4px;">{invoicesCount}</div>
            </div>
             <div style="background: var(--color-bg); padding: 12px; border-radius: 12px; text-align: center;">
              <div class="muted" style="font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600;">Next Bill</div>
              <div style="font-size: 24px; font-weight: 800; color: var(--color-text); margin-top: 4px;">{renewalDays ?? "â€”"}d</div>
            </div>
          </div>
        </div>

        <!-- Quick Actions -->
        { sub.active ? (
          <div class="card">
            <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 16px;">Quick Actions</h3>
            <div style="display: flex; flex-direction: column; gap: 12px;">
              <form action="/api/portal" method="POST">
                 <button class="btn btn-outline" style="width: 100%; justify-content: flex-start;">
                    Update Payment Method
                 </button>
              </form>
               <form action="/api/cancel" method="POST">
                  <input type="hidden" name="at_period_end" value="true" />
                  <button class="btn btn-outline" style="width: 100%; justify-content: flex-start; color: #ef4444; border-color: color-mix(in oklab, #ef4444 20%, transparent);">
                    Cancel Subscription
                  </button>
              </form>
            </div>
          </div>
        ) : null }

        <div style="padding: 16px; text-align: center;">
           <p class="muted" style="font-size: 14px; margin-bottom: 8px;">Need help?</p>
           <a href="mailto:support@fastscout.app" style="font-weight: 600; color: var(--color-primary);">Contact Support</a>
        </div>
      </div>

    </div>
  </section>

  <style>
    .dashboard-grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 32px;
    }
    .sub-card {
      background: var(--gradient-primary);
      color: white;
      border: none;
      min-height: 220px;
      display: flex;
      flex-direction: column;
      box-shadow: var(--shadow-glow);
    }
    .status-pill {
      padding: 4px 12px;
      border-radius: 100px;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .status-pill.active { background: #22c55e; color: white; box-shadow: 0 0 12px rgba(34, 197, 94, 0.4); }
    .status-pill.inactive { background: rgba(255,255,255,0.2); color: white; }

    .invoice-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .invoice-list li {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 0;
      border-bottom: 1px solid var(--color-border);
    }
    .invoice-list li:last-child { border-bottom: none; padding-bottom: 0; }
    
    .btn-icon {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      color: var(--color-text-muted);
      transition: all 0.2s;
    }
    .btn-icon:hover { background: var(--color-bg-card); color: var(--color-primary); }

    @media (max-width: 800px) {
      .dashboard-grid { grid-template-columns: 1fr; }
    }
  </style>
</Layout>
