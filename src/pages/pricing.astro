---
import Layout from "../shared/Layout.astro";
import stripe, { findActiveSubscriptionByEmail, findActiveSubscriptionByCustomerId } from "../lib/stripe";
import { getSupabaseServerClient } from "../lib/supabase";

let monthlyId = import.meta.env.STRIPE_PRICE_ID_MONTHLY as string | undefined;
const yearlyId = import.meta.env.STRIPE_PRICE_ID_YEARLY as string | undefined;
const fallbackId = import.meta.env.STRIPE_PRICE_ID as string | undefined;
if (!monthlyId && fallbackId) monthlyId = fallbackId;
const supabase = getSupabaseServerClient(Astro);
const { data: userData } = await supabase.auth.getUser();
const userId = userData.user?.id as string | undefined;
const userEmail = userData.user?.email as string | undefined;
const urlError = new URL(Astro.request.url).searchParams.get("error");
let errorBanner: string | null = null;
if (urlError === "rate_limited") errorBanner = "Too many requests. Try again in a minute.";
else if (urlError === "checkout_failed") errorBanner = "Checkout failed. Please try again.";
else if (urlError === "missing_price_id") errorBanner = "Price configuration missing.";
else if (urlError === "already_subscribed") errorBanner = "You already have an active subscription.";
let subActive = false;
let subPriceId: string | undefined;

// Fetch subscription_status and billing_customers in parallel
const [statusResult, billingResult] = await Promise.all([
  userId
    ? supabase.from("subscription_status").select("active, price_id").eq("user_id", userId).maybeSingle()
    : Promise.resolve({ data: null }),
  userId
    ? supabase.from("billing_customers").select("stripe_customer_id").eq("user_id", userId).maybeSingle()
    : Promise.resolve({ data: null })
]);

const status = statusResult.data;
const billingMap = billingResult.data;

if (status) {
  subActive = !!status.active;
  subPriceId = status.price_id ?? undefined;
}

// Only call Stripe if DB says not active
if (!subActive && userEmail && userId) {
  const customerId = billingMap?.stripe_customer_id as string | undefined;
  if (customerId) {
    const res = await findActiveSubscriptionByCustomerId(customerId);
    subActive = res.active;
    subPriceId = subPriceId ?? res.priceId;
  } else {
    const res = await findActiveSubscriptionByEmail(userEmail);
    subActive = res.active;
    subPriceId = subPriceId ?? res.priceId;
  }
}

// Use env vars for price amounts (primary), Stripe API as fallback
let monthlyAmount = parseInt(import.meta.env.STRIPE_PRICE_MONTHLY_AMOUNT ?? "0") || 0;
let yearlyAmount = parseInt(import.meta.env.STRIPE_PRICE_YEARLY_AMOUNT ?? "0") || 0;
let monthlyCurrency = (import.meta.env.STRIPE_PRICE_CURRENCY ?? "USD").toUpperCase();
let yearlyCurrency = monthlyCurrency;

// Only fetch from Stripe if env vars not set
if (!monthlyAmount || !yearlyAmount) {
  try {
    const pricePromises: Promise<void>[] = [];
    if (!monthlyAmount && monthlyId) {
      pricePromises.push(
        stripe.prices.retrieve(monthlyId).then(p => {
          monthlyAmount = p.unit_amount ?? 500;
          monthlyCurrency = (p.currency ?? "usd").toUpperCase();
        })
      );
    }
    if (!yearlyAmount && yearlyId) {
      pricePromises.push(
        stripe.prices.retrieve(yearlyId).then(p => {
          yearlyAmount = p.unit_amount ?? 5000;
          yearlyCurrency = (p.currency ?? "usd").toUpperCase();
        })
      );
    }
    await Promise.all(pricePromises);
  } catch {}
}

// Default fallbacks
if (!monthlyAmount) monthlyAmount = 500;
if (!yearlyAmount) yearlyAmount = 5000;
const monthlyDisplay = `$${(monthlyAmount / 100).toFixed(0)}/mo`;
const yearlyDisplay = `$${(yearlyAmount / 100).toFixed(0)}/yr`;
---
<Layout title="Pricing">
  <section style="max-width: 900px; margin: 0 auto;">
    <div style="text-align: center; margin-bottom: 60px;">
      <h2 style="font-size: 3rem; margin-bottom: 16px;">Simple Pricing</h2>
      <p class="lead" style="max-width: 500px; margin: 0 auto;">Transparent pricing for professionals. Choose the plan that fits your workflow.</p>
    </div>

    <style is:inline>
      .pricing-grid { 
        display: grid; 
        grid-template-columns: repeat(2, 1fr); 
        gap: 32px; 
        max-width: 800px;
        margin: 0 auto;
      }
      .plan { 
        padding: 40px;
        display: flex;
        flex-direction: column;
        height: 100%;
      }
      .plan--featured { 
        border: 2px solid transparent;
        background: linear-gradient(var(--color-bg-card), var(--color-bg-card)) padding-box,
                    var(--gradient-primary) border-box;
        box-shadow: 0 20px 40px -10px rgba(37, 99, 235, 0.15);
        color: var(--color-text);
      }
      .plan-header { margin-bottom: 32px; }
      .price-tag { font-size: 42px; font-weight: 800; color: var(--color-text); line-height: 1; }
      .price-period { font-size: 16px; color: var(--color-text-muted); font-weight: 500; }
      
      .feature-list { margin: 32px 0; flex-grow: 1; }
      .feature-list li { margin-bottom: 16px; font-size: 16px; }
      
      @media (max-width: 768px) { .pricing-grid { grid-template-columns: 1fr; max-width: 400px; } }
    </style>

    {
      errorBanner ? (
        <div class="card" style="border-color:#ef4444;background: color-mix(in oklab, #ef4444 12%, transparent); margin-bottom:32px; text-align:center">
          <strong style="color:#ef4444">Error</strong>
          <p class="lead" style="margin-top:6px">{errorBanner}</p>
          {
            urlError === "already_subscribed" ? (
              <div style="margin-top:10px">
                <a class="btn" href="/dashboard">Go to dashboard</a>
              </div>
            ) : null
          }
        </div>
      ) : null
    }

    <div class="pricing-grid">
      <!-- Monthly Plan -->
      <div class="card plan">
        <div class="plan-header">
          <h3 style="font-size: 20px; font-weight: 600; margin-bottom: 8px;">Monthly</h3>
          <div style="display:flex; align-items:baseline; gap:4px">
            <span class="price-tag">{monthlyDisplay}</span>
          </div>
          <p class="muted" style="margin-top: 8px;">Flexible access, cancel anytime.</p>
        </div>
        
        <ul class="feature-list">
          <li>Full Dashboard Access</li>
          <li>Unlimited Quick Bids</li>
          <li>Chrome Extension</li>
          <li>Standard Support</li>
        </ul>

        <div style="margin-top: auto;">
        {
          subActive ? (
            subPriceId === monthlyId ? (
              <button class="btn btn-outline" style="width: 100%;" disabled>Current Plan</button>
            ) : (
              <form action="/api/change-plan" method="POST">
                <input type="hidden" name="plan" value="monthly" />
                <button class="btn btn-outline" style="width: 100%;" type="submit">Switch to Monthly</button>
              </form>
            )
          ) : (
            <form action="/api/checkout" method="POST">
              <input type="hidden" name="plan" value="monthly" />
              <button class="btn btn-outline" style="width: 100%;" type="submit">Choose Monthly</button>
            </form>
          )
        }
        </div>
      </div>

      <!-- Annual Plan (Featured) -->
      <div class="card plan plan--featured">
        <div class="plan-header">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 8px;">
            <h3 style="font-size: 20px; font-weight: 600; margin:0;">Annual</h3>
            <span class="badge">Best Value</span>
          </div>
          <div style="display:flex; align-items:baseline; gap:4px">
            <span class="price-tag">{yearlyDisplay}</span>
          </div>
          <p class="muted" style="margin-top: 8px;">Commit to growth & save 17%.</p>
        </div>

        <ul class="feature-list">
          <li><strong>Everything in Monthly</strong></li>
          <li>Priority Support</li>
          <li>Early Access to Features</li>
          <li>Dedicated Account Review</li>
        </ul>

        <div style="margin-top: auto;">
        {
          subActive ? (
            subPriceId === yearlyId ? (
              <button class="btn btn-primary" style="width: 100%;" disabled>Current Plan</button>
            ) : (
              <form action="/api/change-plan" method="POST">
                <input type="hidden" name="plan" value="annual" />
                <button class="btn btn-primary" style="width: 100%;" type="submit">Switch to Annual</button>
              </form>
            )
          ) : (
            <form action="/api/checkout" method="POST">
              <input type="hidden" name="plan" value="annual" />
              <button class="btn btn-primary" style="width: 100%;" type="submit">Choose Annual</button>
            </form>
          )
        }
        </div>
      </div>
    </div>

    <div class="card" style="margin-top: 60px; text-align: left;">
      <h3 style="margin-bottom: 24px;">Frequently Asked Questions</h3>
      <div class="grid grid-2">
        <div>
          <h4 style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">Can I cancel anytime?</h4>
          <p class="muted" style="font-size: 15px; line-height: 1.6;">Yes, absolutely. You can cancel your subscription at any time from your dashboard settings. Your access will continue until the end of your billing period.</p>
        </div>
        <div>
          <h4 style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">How are invoices handled?</h4>
          <p class="muted" style="font-size: 15px; line-height: 1.6;">Invoices are automatically generated and emailed to you. You can also view and download past invoices directly from your dashboard.</p>
        </div>
      </div>
    </div>
  </section>
</Layout>
